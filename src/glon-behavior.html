<script>
  window.gl = {behavior:{},queryLocalize:{},element:{}};

  let localesBehavior = {
    attached: function(){
      this.set('language',localStorage.glLanguage);
      this.resources = mergeLocales;
    },
    glSwitchLanguage: function(local){
      localStorage.glLanguage = local;
      for(var key in gl.queryLocalize) {
        gl.queryLocalize[key].language = local;
      }
    },
    ready: function(){
      gl.queryLocalize[this.is] = this;
    },
    detached:function(){
      delete gl.queryLocalize[this.is]; 
    }
  };
  gl.behavior.locales = [Polymer.AppLocalizeBehavior, localesBehavior];

  gl.behavior.core = {
      glChangePath: function(path) {
        window.gl.glonSystem.changePath(path);
      },
      glSetLayout: function(layout){
        window.gl.glonSystem.layout = layout;
      },
      glSetTitle:function(txt){
        document.title = txt;
      },
      glQuery:function(name,el='get'){
        if(el!='get'){
          gl.element[name] = el;
        }else{
          return gl.element[name];
        }
      },
      glClone:function(data){
        return JSON.parse(JSON.stringify(data));
      },
      glBind:function(name,props){
       
        if(typeof props!='undefined'){
          this.glBindlisten = true;
          this.listen(document, `gl-event-${name}`,'glBindOn');
          this.glBindProps = props;

          var waitForProps = () => {
            this.async(()=>{
              if(!this.glQuery(`gl-event-${name}`)){
                waitForProps();
              }else{
                props.map((prop)=>{
                  if(this.glQuery(`gl-event-${name}`)[prop]){
                    this[prop] = this.glQuery(`gl-event-${name}`)[prop];
                  }
                });
              }
            }, 10);
          }
          waitForProps();
        }else{
          this.glBindName = `gl-event-${name}`;
          this.glQuery(`gl-event-${name}`,this);
          //this.glQuery(`gl-event-${name}`).glBindName = 'xx';
        }

      },
      glBindOb:function(ob){
        var prop = ob.path.split(".");
        this.fire(`${this.glBindName}`, {value: ob.base, prop: prop[0]});
      },
      glBindOn:function(e){
        this.glBindProps.map((prop)=>{
          if(prop==e.detail.prop){
            this[e.detail.prop] = e.detail.value;
          }
        });
        
      },
      detached:function(){
        if(this.glBindlisten){
          this.listen(document, `gl-event-${name}`,'glBindOn');
        }
      },
      glStrToInt:function(ob,param){
          if(ob.path.split(".").length == 2){
              ob.base[param]=parseInt(ob.value);
          }
      },
      glStrToFloat:function(ob,param){
          if(ob.path.split(".").length == 2){
              ob.base[param]=parseFloat(ob.value);
          }
      },
      glCurrency:function(val){
        return parseFloat(val).toLocaleString();
      }
  };

  gl.behavior.template = {
    observers:['getPage(page)'],
    getPage:function(page){

      const changePage = ()=>{
        console.log('change');
        var queryTag = this.$$('tag-page-load');
        queryTag.innerHTML='';
        queryTag.appendChild(page);
      }

      if(typeof this.oldRoute=="undefined"){
        changePage();
      }else if(this.route.app!=this.oldRoute.app){
        changePage();
      }else if(this.route.app==this.oldRoute.app && this.route.page!=this.oldRoute.page){
        changePage();
      }
      
      this.oldRoute = this.route;
    },
    testObj:function(route){
      console.log(route);
    }
  };

  gl.behavior.notification = {
    glNotify:function(title,msg,icon,time=5000){

      var options = {
        body: msg,
        icon: icon,
      }

      var notify = ()=>{
        var n = new Notification(title,options);
        setTimeout(n.close.bind(n), time);
      }

      if (!("Notification" in window)) {
        console.warn("This browser does not support desktop notification");
      } else if (Notification.permission === "granted") {
        notify();
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission(function (permission) {
          if (permission === "granted") {
            notify();
          }
        });
      }
    }
  }

</script>
